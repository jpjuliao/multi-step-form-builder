name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, hash, json, pcre, session, simplexml, spl, tokenizer, curl
        
    - name: Get Composer Cache Directory
      id: composer-cache
      run: |
        echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
        
    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-
          
    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress --no-suggest --optimize-autoloader --no-dev
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json
        
    - name: Install npm dependencies
      run: npm ci
      
    - name: Build JavaScript assets
      run: npm run build
      
    - name: Run tests before release
      run: |
        composer run test
        npm test || true  # Allow to fail for now
        
    - name: Create plugin zip package
      run: |
        # Get version from tag
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "Version: $VERSION"
        
        # Create temporary directory
        mkdir -p release-temp
        mkdir -p release
        
        # Copy plugin files (excluding development files)
        rsync -av --exclude-from=.gitignore \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='vendor' \
          --exclude='tests' \
          --exclude='coverage' \
          --exclude='.github' \
          --exclude='*.log' \
          --exclude='.phpunit.result.cache' \
          --exclude='composer.lock' \
          --exclude='package-lock.json' \
          --exclude='src' \
          --exclude='webpack.config.js' \
          --exclude='.eslintrc.*' \
          --exclude='jest.config.*' \
          --exclude='DEVELOPMENT.md' \
          --exclude='IMPLEMENTATION_SUMMARY.md' \
          . release-temp/multi-step-form-builder-by-jpjuliao/
          
        # Copy built assets
        cp -r build/* release-temp/multi-step-form-builder-by-jpjuliao/ || true
        
        # Create zip file
        cd release-temp
        zip -r ../release/multi-step-form-builder-by-jpjuliao-v${VERSION}.zip multi-step-form-builder-by-jpjuliao/
        cd ..
        
        # List contents
        ls -la release/
        
    - name: Generate changelog
      id: changelog
      run: |
        # Get previous tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "## Changes since $PREVIOUS_TAG" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> CHANGELOG.md
        else
          echo "## Initial Release" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" >> CHANGELOG.md
        fi
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*.zip
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload release artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-packages
        path: release/
        retention-days: 30

  deploy-to-wordpress-org:
    runs-on: ubuntu-latest
    needs: create-release
    if: startsWith(github.ref, 'refs/tags/v')
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download release artifacts
      uses: actions/download-artifact@v3
      with:
        name: release-packages
        path: ./release
        
    - name: Deploy to WordPress.org (placeholder)
      run: |
        echo "WordPress.org deployment would go here"
        echo "This requires SVN access and additional configuration"
        echo "Current release files:"
        ls -la release/
        
        # Example of what WordPress.org deployment might look like:
        # svn checkout https://plugins.svn.wordpress.org/multi-step-form-builder-by-jpjuliao/trunk
        # cp -r release/* trunk/
        # svn commit -m "Release ${{ github.ref_name }}"
